name: Smart Merge IPTV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------- Download playlists --------
      - name: Download playlists
        run: |
          curl -sL "https://livetv-cb7.pages.dev/hotstar" -o 1.m3u
          curl -sL "https://raw.githubusercontent.com/cloudplay97/m3u/refs/heads/main/sony.m3u" -o 2.m3u
          curl -sL "https://raw.githubusercontent.com/drmlive/sliv-live-events/main/sonyliv.m3u" -o 3.m3u
          curl -sL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o 4.m3u

      # -------- Clean + Merge (TiviMate safe) --------
      - name: Build merged playlist
        run: |
          echo "#EXTM3U" > new.m3u

          for f in 1.m3u 2.m3u 3.m3u 4.m3u; do
            # remove header + Windows line endings + blank lines
            sed '1{/^#EXTM3U/d}; s/\r$//; /^$/d' "$f" >> new.m3u
          done

      # -------- Change detection --------
      - name: Check changes
        id: diff
        run: |
          if [ -f merged3.m3u ] && cmp -s merged3.m3u new.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # -------- Replace only if changed --------
      - name: Update file
        if: steps.diff.outputs.changed == 'true'
        run: mv new.m3u merged3.m3u

      # -------- Commit only if changed --------
      - name: Commit
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add merged3.m3u
          git commit -m "Auto update merged3 IPTV (clean TiviMate safe)"
          git push
