
name: Auto Update Sony M3U Tokens

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */4 * * *'   # every 4 hours
  workflow_dispatch:

jobs:
  update-sony:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install dependencies
        run: pip install requests

      - name: ğŸ”„ Fetch & Update Sony M3U
        run: |
          python - <<'PY'
          import re, requests, os, time
          from datetime import datetime

          API_URL = "https://livetv-cb7.pages.dev/temp"
          LOCAL_FILE = "sony.m3u"

          headers = {
              "User-Agent": "Dalvik/2.1.0 (Linux; Android 10)",
              "Accept": "*/*",
              "Accept-Encoding": "gzip",
              "Connection": "keep-alive",
          }

          # ---------------- FETCH ----------------
          def fetch_playlist():
              for attempt in range(3):
                  try:
                      print(f"ğŸ”„ Fetching playlist (attempt {attempt+1})...")
                      r = requests.get(API_URL, headers=headers, timeout=30)
                      print(f"âœ… HTTP {r.status_code}, bytes={len(r.content)}")

                      r.encoding = "utf-8"
                      if r.status_code == 200 and "#EXTINF" in r.text:
                          print("âœ… Valid M3U detected")
                          return r.text

                  except Exception as e:
                      print("âš ï¸ Error:", e)

                  time.sleep(2)

              print("âŒ Failed to fetch valid playlist")
              exit(1)

          data = fetch_playlist()

          # Ensure EXTM3U header
          if not data.lstrip().startswith("#EXTM3U"):
              data = "#EXTM3U\n" + data

          # ---------------- PARSER ----------------
          def parse_m3u(content):
              entries = []
              lines = [l.strip() for l in content.splitlines() if l.strip()]

              for i in range(len(lines)):
                  if lines[i].startswith("#EXTINF"):
                      header = lines[i]
                      if i + 1 >= len(lines):
                          continue
                      url = lines[i + 1].strip()

                      tvg_id = re.search(r'tvg-id="([^"]+)"', header)
                      tvg_name = re.search(r'tvg-name="([^"]+)"', header)

                      raw_name = tvg_name.group(1) if tvg_name else ""
                      norm_name = (
                          raw_name.lower()
                          .replace(" ", "")
                          .replace("-", "")
                          .replace("_", "")
                      )

                      entries.append({
                          "id": tvg_id.group(1).lower() if tvg_id else "",
                          "name": norm_name,
                          "raw_name": raw_name,
                          "header": header,
                          "url": url
                      })
              return entries

          new_entries = parse_m3u(data)

          # ---------------- SONY FILTER ----------------
          sony_new = [
              e for e in new_entries
              if "sony" in e["raw_name"].lower()
              or e["id"].startswith("1000009")
          ]

          print(f"ğŸ¯ Sony channels found: {len(sony_new)}")

          if not sony_new:
              print("âš ï¸ No Sony channels found. Exiting.")
              exit(0)

          # ---------------- CREATE FILE ----------------
          if not os.path.exists(LOCAL_FILE):
              print("ğŸ“„ Creating sony.m3u")
              out = [
                  "#EXTM3U",
                  f"# Created: {datetime.utcnow().isoformat()} UTC",
                  ""
              ]
              for e in sony_new:
                  out.append(e["header"])
                  out.append(e["url"])

              with open(LOCAL_FILE, "w", encoding="utf-8") as f:
                  f.write("\n".join(out))

              print("âœ… sony.m3u created")
              exit(0)

          # ---------------- UPDATE EXISTING ----------------
          with open(LOCAL_FILE, "r", encoding="utf-8") as f:
              old_data = f.read()

          old_entries = parse_m3u(old_data)

          updated = []
          updated_count = 0
          added_count = 0

          def find_match(old):
              for n in sony_new:
                  if old["id"] and old["id"] == n["id"]:
                      return n
                  if old["name"] and old["name"] == n["name"]:
                      return n
              return None

          updated.extend([
              "#EXTM3U",
              f"# Updated: {datetime.utcnow().isoformat()} UTC",
              ""
          ])

          for old in old_entries:
              match = find_match(old)
              if match:
                  if old["url"] != match["url"]:
                      updated_count += 1
                      print(f"ğŸ” Updated: {old['raw_name']}")
                  updated.append(match["header"])
                  updated.append(match["url"])
              else:
                  updated.append(old["header"])
                  updated.append(old["url"])

          old_names = {o["name"] for o in old_entries}

          for n in sony_new:
              if n["name"] not in old_names:
                  updated.append(n["header"])
                  updated.append(n["url"])
                  added_count += 1
                  print(f"ğŸ†• Added: {n['raw_name']}")

          with open(LOCAL_FILE, "w", encoding="utf-8") as f:
              f.write("\n".join(updated))

          print(f"ğŸ‰ Update complete: {updated_count} updated, {added_count} added")
          PY

      - name: ğŸš€ Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sony.m3u
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "ğŸ”„ Auto-update Sony M3U tokens ($(date -u))"
            git push
            echo "âœ… sony.m3u pushed"
          fi
