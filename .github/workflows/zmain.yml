name: Smart Merge IPTV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # SAFE cron (GitHub friendly)

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------- Download all playlists --------
      - name: Download sources
        run: |
          curl -sL "https://livetv-cb7.pages.dev/hotstar" -o ztv.m3u
          curl -sL "https://raw.githubusercontent.com/cloudplay97/m3u/refs/heads/main/sony.m3u" -o sony.m3u
          curl -sL "https://raw.githubusercontent.com/drmlive/sliv-live-events/main/sonyliv.m3u" -o sonyliv.m3u
          curl -sL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o fancode.m3u

      # -------- Merge --------
      - name: Build merged playlist
        run: |
          echo "#EXTM3U" > new_merged.m3u
          tail -n +2 ztv.m3u >> new_merged.m3u
          tail -n +2 sony.m3u >> new_merged.m3u
          tail -n +2 sonyliv.m3u >> new_merged.m3u
          tail -n +2 fancode.m3u >> new_merged.m3u

      # -------- Change detection --------
      - name: Check for changes
        id: diff
        run: |
          if [ -f merged.m3u ] && cmp -s merged.m3u new_merged.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # -------- Replace only if changed --------
      - name: Update merged.m3u
        if: steps.diff.outputs.changed == 'true'
        run: mv new_merged.m3u merged.m3u

      # -------- Commit only if changed --------
      - name: Commit update
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add merged.m3u
          git commit -m "Smart auto update IPTV"
          git push
